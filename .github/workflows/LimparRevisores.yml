name: Limpar Revisores antigos

on:
  pull_request:
    types:
      - review_requested
      - assigned      
jobs:  
  Pull-request-action:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
    steps:
    
    - name: Limpar Revisores
      run: |

            if [ "$GITHUB_EVENT_NAME" != "pull_request" ]; then
              echo "Esta execução não foi desencadeada por um evento pull_request. Saindo..."
              exit 0
            fi

            # Verifica se já foi marcado para evitar loops
            if [ -n "$REMOVE_REVIEWERS_MARKED" ]; then
              echo "Já marcado para remover revisores. Saindo..."
              exit 0
            fi

            # Marca para evitar loops
            echo "REMOVE_REVIEWERS_MARKED=true" >> $GITHUB_ENV
            
            response=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/requested_reviewers")   
            
            if [[ $? -eq 0 && $(echo "$response" | jq -e '.message') == "null" ]]; then
              team_reviewers=$(echo "$response" | jq -r '.teams[].slug' || echo "[]")
              reviewers=$(echo "$response" | jq -r '.users[].login' || echo "[]")

            # Cria um array para cada variável de saída
            team_reviewers_array=($team_reviewers)
            reviewers_array=($reviewers)

            fi  
              payload='{"reviewers":['
              first=true
              for reviewer in $reviewers; do
                if [ "$first" = true ]; then
                  first=false
                else
                  payload+=','
                fi
                payload+="\"$reviewer\""
              done

              payload+='],"team_reviewers":['
              first=true
              for team_reviewer in $team_reviewers; do
                if [ "$first" = true ]; then
                  first=false
                else
                  payload+=','
                fi
                payload+="\"raizen-it/$team_reviewer\""
              done
              payload+=']}'

               echo "PAYLOAD: $payload"
          
              if [ -n "$payload" ]; then
                curl -X DELETE \
                  -H "Accept: application/vnd.github+json" \
                  -H "Authorization: Bearer $GITHUB_TOKEN" \
                  -H "X-GitHub-Api-Version: 2022-11-28" \
                  -d "$payload" \
                  "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/requested_reviewers"
          
                echo "Revisores e revisores de equipe removidos com sucesso"
              else
                echo "Nenhum revisor ou revisor de equipe a ser removido"
              fi
